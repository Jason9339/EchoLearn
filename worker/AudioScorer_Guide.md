# AudioScorer ä½¿ç”¨æŒ‡å—

## å¿«é€Ÿé–‹å§‹

```python
from services.audio_scorer import AudioScorer

# åˆå§‹åŒ–
scorer = AudioScorer()

# è©•åˆ†
scores = scorer.score("reference.wav", "test.wav")

# çµæœ
print(scores)
# {'PER': 0.95, 'PPG': 0.92, 'GOP': 0.88, 'GPE_offset': 0.91,
#  'FFE': 0.89, 'WER': 0.85, 'Energy': 0.87, 'VDE': 0.93}

# å¹³å‡åˆ†æ•¸
avg = sum(scores.values()) / len(scores)
print(f"ç¸½åˆ†: {avg:.2%}")  # ç¸½åˆ†: 89.88%
```

---

## è©•åˆ†æŒ‡æ¨™èªªæ˜ï¼ˆ8 å€‹æŒ‡æ¨™ï¼‰

æ‰€æœ‰æŒ‡æ¨™ç¯„åœç‚º **[0, 1]**ï¼Œ**è¶Šé«˜è¶Šå¥½**ã€‚

### éŸ³ç´ ç›¸é—œæŒ‡æ¨™ï¼ˆä½¿ç”¨ PhoneCTCï¼‰

| æŒ‡æ¨™ | èªªæ˜ | è©•ä¼°å…§å®¹ |
|------|------|----------|
| **PER** | Phoneme Error Rate Similarity | éŸ³ç´ åºåˆ—æº–ç¢ºåº¦ï¼Œ1.0 = å®Œå…¨åŒ¹é… |
| **PPG** | Posteriorgram Similarity | éŸ³ç´ å¾Œé©—æ©Ÿç‡åˆ†ä½ˆç›¸ä¼¼åº¦ |
| **GOP** | Goodness of Pronunciation | ç™¼éŸ³è³ªé‡ï¼ŒåŸºæ–¼éŸ³ç´ å°æ•¸æ©Ÿç‡ |

### éŸ»å¾‹ç›¸é—œæŒ‡æ¨™ï¼ˆä½¿ç”¨ SpeechMetrics + Praatï¼‰

| æŒ‡æ¨™ | èªªæ˜ | è©•ä¼°å…§å®¹ |
|------|------|----------|
| **GPE_offset** | Gross Pitch Error (offset-compensated) | éŸ³é«˜è¼ªå»“ç›¸ä¼¼åº¦ï¼Œè‡ªå‹•è£œå„Ÿç”·å¥³è²å·®ç•° |
| **FFE** | F0 Frame Error | F0 å¹€æº–ç¢ºåº¦ï¼ˆåŒ…å«æ¿éŸ³åˆ¤æ–·å’ŒéŸ³é«˜èª¤å·®ï¼‰|
| **Energy** | Energy Similarity | éŸ³é‡è®ŠåŒ–æ¨¡å¼ç›¸ä¼¼åº¦ |
| **VDE** | Voiced Decision Error | æ¿éŸ³/ç„¡è²åˆ¤æ–·æº–ç¢ºåº¦ |

### èªéŸ³è­˜åˆ¥æŒ‡æ¨™ï¼ˆä½¿ç”¨ Whisperï¼‰

| æŒ‡æ¨™ | èªªæ˜ | è©•ä¼°å…§å®¹ |
|------|------|----------|
| **WER** | Word Error Rate Similarity | è©å½™æº–ç¢ºåº¦ï¼Œå·²è½‰æ›ç‚ºç›¸ä¼¼åº¦æ ¼å¼ `max(0, 1-WER)` |

---

## å¸¸è¦‹ç”¨æ³•

### æ‰¹æ¬¡è©•åˆ†

```python
scorer = AudioScorer()

for recording in ["rec1.wav", "rec2.wav", "rec3.wav"]:
    scores = scorer.score("reference.wav", recording)
    avg = sum(scores.values()) / len(scores)
    print(f"{recording}: {avg:.2%}")
```

### æ‰¾å‡ºæœ€ä½³éŒ„éŸ³

```python
scorer = AudioScorer()
recordings = ["rec1.wav", "rec2.wav", "rec3.wav"]

results = []
for rec in recordings:
    scores = scorer.score("reference.wav", rec)
    avg = sum(scores.values()) / len(scores)
    results.append((rec, avg))

best = max(results, key=lambda x: x[1])
print(f"æœ€ä½³éŒ„éŸ³: {best[0]} ({best[1]:.2%})")
```

### è¨ºæ–·å¼±é»

```python
scores = scorer.score("reference.wav", "test.wav")

# æ‰¾å‡ºæœ€éœ€è¦æ”¹é€²çš„æŒ‡æ¨™
weak_points = sorted(scores.items(), key=lambda x: x[1])[:3]
print("éœ€è¦æ”¹é€²:")
for metric, score in weak_points:
    if score < 0.85:
        print(f"  {metric}: {score:.2%}")
```

### å®Œæ•´è©•ä¼°å ±å‘Š

```python
from services.audio_scorer import AudioScorer

scorer = AudioScorer()
scores = scorer.score("reference.wav", "test.wav")

print("=" * 60)
print("èªéŸ³è©•ä¼°å ±å‘Š")
print("=" * 60)

print("\nã€éŸ³ç´ æº–ç¢ºåº¦ã€‘")
print(f"  PER ç›¸ä¼¼åº¦:        {scores['PER']:>6.2%}")
print(f"  PPG ç›¸ä¼¼åº¦:        {scores['PPG']:>6.2%}")
print(f"  GOP ç™¼éŸ³è³ªé‡:      {scores['GOP']:>6.2%}")

print("\nã€éŸ»å¾‹ç‰¹å¾µã€‘")
print(f"  éŸ³é«˜è¼ªå»“:          {scores['GPE_offset']:>6.2%}")
print(f"  F0 æº–ç¢ºåº¦:         {scores['FFE']:>6.2%}")
print(f"  èƒ½é‡è®ŠåŒ–:          {scores['Energy']:>6.2%}")
print(f"  æ¿éŸ³åˆ¤æ–·:          {scores['VDE']:>6.2%}")

print("\nã€èªéŸ³è­˜åˆ¥ã€‘")
print(f"  WER ç›¸ä¼¼åº¦:        {scores['WER']:>6.2%}")

print("\nã€ç¸½é«”è©•åˆ†ã€‘")
avg = sum(scores.values()) / len(scores)
print(f"  å¹³å‡åˆ†æ•¸:          {avg:>6.2%}")

# è©•ç´š
if avg >= 0.95:
    grade = "å„ªç§€ â­â­â­â­â­"
elif avg >= 0.85:
    grade = "è‰¯å¥½ â­â­â­â­"
elif avg >= 0.75:
    grade = "ä¸­ç­‰ â­â­â­"
else:
    grade = "éœ€æ”¹é€² â­â­"
print(f"  è©•ç´š:              {grade}")
print("=" * 60)
```

---

## è©•åˆ†æ¨™æº–åƒè€ƒ

| å¹³å‡åˆ†æ•¸ | è©•ç´š | èªªæ˜ |
|---------|------|------|
| â‰¥ 95% | å„ªç§€ â­â­â­â­â­ | ç™¼éŸ³éå¸¸æ¨™æº–ï¼Œå„æ–¹é¢è¡¨ç¾æ¥µä½³ |
| â‰¥ 85% | è‰¯å¥½ â­â­â­â­ | ç™¼éŸ³è‰¯å¥½ï¼Œåƒ…æœ‰å°‘æ•¸éœ€æ”¹é€²ä¹‹è™• |
| â‰¥ 75% | ä¸­ç­‰ â­â­â­ | ç™¼éŸ³å°šå¯ï¼Œå»ºè­°åŠ å¼·ç·´ç¿’ |
| < 75% | éœ€æ”¹é€² â­â­ | å»ºè­°å¤šåŠ ç·´ç¿’ï¼Œç‰¹åˆ¥æ³¨æ„ç™¼éŸ³æº–ç¢ºåº¦ |

---

## åˆå§‹åŒ–åƒæ•¸

```python
AudioScorer(
    phoneme_model: str = "facebook/wav2vec2-lv-60-espeak-cv-ft",
    device: torch.device = None
)
```

**åƒæ•¸èªªæ˜ï¼š**
- `phoneme_model`: éŸ³ç´ è­˜åˆ¥æ¨¡å‹ï¼ˆé è¨­ç‚ºå¤šèªè¨€æ¨¡å‹ï¼Œæ”¯æ´ 61 ç¨®èªè¨€ï¼‰
- `device`: è¨ˆç®—è£ç½®ï¼ˆé è¨­è‡ªå‹•é¸æ“‡ GPU/CPUï¼‰

**é‡è¦å»ºè­°ï¼š**
- åªéœ€åˆå§‹åŒ–ä¸€æ¬¡ï¼ˆè¼‰å…¥æ¨¡å‹éœ€è¦æ™‚é–“ï¼‰
- é‡è¤‡ä½¿ç”¨åŒä¸€å€‹ `scorer` å¯¦ä¾‹é€²è¡Œæ‰¹æ¬¡è©•åˆ†
- ä½¿ç”¨ GPU å¯å¤§å¹…æå‡é€Ÿåº¦

---

## è¿”å›æ ¼å¼

`score()` æ–¹æ³•è¿”å›ä¸€å€‹å­—å…¸ï¼Œæ‰€æœ‰å€¼éƒ½åœ¨ [0, 1] ç¯„åœå…§ï¼š

```python
{
    'PER': float,        # éŸ³ç´ éŒ¯èª¤ç‡ç›¸ä¼¼åº¦
    'PPG': float,        # éŸ³ç´ å¾Œé©—åœ–ç›¸ä¼¼åº¦
    'GOP': float,        # ç™¼éŸ³è³ªé‡
    'GPE_offset': float, # éŸ³é«˜ç›¸ä¼¼åº¦ï¼ˆè£œå„Ÿåç§»ï¼‰
    'FFE': float,        # F0 å¹€ç›¸ä¼¼åº¦
    'WER': float,        # è©éŒ¯èª¤ç‡ç›¸ä¼¼åº¦
    'Energy': float,     # èƒ½é‡ç›¸ä¼¼åº¦
    'VDE': float         # æ¿éŸ³åˆ¤æ–·ç›¸ä¼¼åº¦
}
```

---

## æ¸¬è©¦çµæœç¯„ä¾‹

### T1: åŒæª”å°è‡ªå·±ï¼ˆç†æƒ³æƒ…æ³ï¼‰

```
PER:         1.0000 âœ…
PPG:         1.0000 âœ…
GOP:         0.9889 âœ… (ç•¥ä½æ–¼ 1.0 æ˜¯æ­£å¸¸çš„)
GPE_offset:  1.0000 âœ…
FFE:         1.0000 âœ…
WER:         1.0000 âœ…
Energy:      1.0000 âœ…
VDE:         1.0000 âœ…

å¹³å‡: 0.9986 (99.86%)
è©•ç´š: å„ªç§€ â­â­â­â­â­
```

### T3: åŒèªªè©±è€…ä¸åŒå¥

```
PER:         0.4516 (éŸ³ç´ ä¸åŒï¼Œæ­£å¸¸)
PPG:         0.8312 (åˆ†ä½ˆç›¸ä¼¼)
GOP:         0.8634 (ç™¼éŸ³é¢¨æ ¼ä¸€è‡´)
GPE_offset:  0.9715 (éŸ³é«˜è¼ªå»“ç›¸ä¼¼)
FFE:         0.9657 (F0 æ¨¡å¼ç›¸ä¼¼)
WER:         0.0000 (å®Œå…¨ä¸åŒçš„å¥å­)
Energy:      0.8829 (èƒ½é‡æ¨¡å¼ç›¸ä¼¼)
VDE:         0.9909 (æ¿éŸ³åˆ¤æ–·ç©©å®š)

å¹³å‡: 0.7447 (74.47%)
è©•ç´š: ä¸­ç­‰ â­â­â­
```

---

## ç³»çµ±æ¶æ§‹

```
AudioScorer (çµ±ä¸€ä»‹é¢)
    â”‚
    â”œâ”€â†’ PhoneCTC (éŸ³ç´ è©•ä¼°)
    â”‚   â”œâ”€ PER  (éŸ³ç´ éŒ¯èª¤ç‡)
    â”‚   â”œâ”€ PPG  (å¾Œé©—åœ–ç›¸ä¼¼åº¦)
    â”‚   â””â”€ GOP  (ç™¼éŸ³è³ªé‡)
    â”‚
    â”œâ”€â†’ SpeechMetrics (éŸ»å¾‹è©•ä¼°)
    â”‚   â”œâ”€ GPE_offset (éŸ³é«˜è¼ªå»“)
    â”‚   â”œâ”€ FFE        (F0 æº–ç¢ºåº¦)
    â”‚   â”œâ”€ Energy     (èƒ½é‡ç›¸ä¼¼åº¦)
    â”‚   â””â”€ VDE        (æ¿éŸ³åˆ¤æ–·)
    â”‚
    â””â”€â†’ Whisper (èªéŸ³è­˜åˆ¥)
        â””â”€ WER (è©éŒ¯èª¤ç‡)
```

---

## å¤šèªè¨€æ”¯æ´

é è¨­çš„ PhoneCTC æ¨¡å‹ï¼ˆ`facebook/wav2vec2-lv-60-espeak-cv-ft`ï¼‰æ”¯æ´ **61 ç¨®èªè¨€**ï¼š

- ğŸ‡¬ğŸ‡§ è‹±èª
- ğŸ‡¨ğŸ‡³ ä¸­æ–‡ï¼ˆç°¡é«”ã€ç¹é«”ã€ç²µèªï¼‰
- ğŸ‡¯ğŸ‡µ æ—¥èª
- ğŸ‡°ğŸ‡· éŸ“èª
- ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™èª
- ğŸ‡«ğŸ‡· æ³•èª
- ğŸ‡©ğŸ‡ª å¾·èª
- ... ç­‰ 54 ç¨®å…¶ä»–èªè¨€

ä½¿ç”¨ eSpeak IPA éŸ³ç´ ç³»çµ±ï¼Œå…·å‚™é›¶æ¨£æœ¬è·¨èªè¨€é·ç§»èƒ½åŠ›ã€‚

---

## èˆ‡èˆŠç³»çµ±çš„å°æ¯”

### ä¹‹å‰ï¼ˆéœ€è¦å¤šå€‹è…³æœ¬ï¼‰
- `test_phoneme_similarity.py` â†’ PER, GOP, PPG
- `test_speech_metrics.py` â†’ VDE, GPE, GPE_log, GPE_offset, Energy, FFE
- `cal_wer_gop.py` â†’ WER, GOP-old
- **å•é¡Œï¼š** 11 å€‹æŒ‡æ¨™ï¼Œæ–¹å‘ä¸ä¸€è‡´ï¼Œéœ€è¦æ‰‹å‹•æ•´åˆ

### ç¾åœ¨ï¼ˆçµ±ä¸€ä»‹é¢ï¼‰
- `AudioScorer.score()` â†’ æ‰€æœ‰ 8 å€‹æŒ‡æ¨™
- **å„ªé»ï¼š** ä¸€æ¬¡å‘¼å«ï¼Œæ–¹å‘çµ±ä¸€ï¼ˆè¶Šé«˜è¶Šå¥½ï¼‰ï¼Œç„¡é‡è¤‡åŠŸèƒ½

---

## ç§»é™¤çš„æŒ‡æ¨™èªªæ˜

| æŒ‡æ¨™ | ç§»é™¤åŸå›  |
|------|----------|
| **GOP-old** | PhoneCTC çš„ GOP-new æ›´å…ˆé€²ï¼Œæ”¯æ´å¤šèªè¨€ |
| **GPE** | GPE_offset æ›´å¯¦ç”¨ï¼ˆè‡ªå‹•è£œå„Ÿç”·å¥³è²éŸ³é«˜å·®ç•°ï¼‰|
| **GPE_log** | åŠŸèƒ½èˆ‡ GPE_offset é‡ç–Š |

---

## æ³¨æ„äº‹é …

1. **åŒæª”æ¸¬è©¦**: åŒä¸€å€‹æª”æ¡ˆå°è‡ªå·±è©•åˆ†æ™‚ï¼Œå¤§éƒ¨åˆ†æŒ‡æ¨™æ‡‰æ¥è¿‘ 1.0ï¼ˆGOP å¯èƒ½ç•¥ä½æ–¼ 1.0 æ˜¯æ­£å¸¸çš„ï¼‰

2. **WER è½‰æ›**: åŸæœ¬æ˜¯éŒ¯èª¤ç‡ï¼ˆè¶Šä½è¶Šå¥½ï¼‰ï¼Œå·²è½‰æ›ç‚º `max(0, 1 - WER)` ç›¸ä¼¼åº¦æ ¼å¼

3. **GOP ç¯„åœ**: å·²å¾åŸå§‹å°æ•¸æ©Ÿç‡ [-10, 0] æ¨™æº–åŒ–åˆ° [0, 1]

4. **æ”¯æ´æ ¼å¼**: è¼¸å…¥éŸ³æª”éœ€è¦æ˜¯ torchaudio å¯è®€å–çš„æ ¼å¼ï¼ˆ.wav, .mp3, .flac ç­‰ï¼‰

5. **æ€§èƒ½å„ªåŒ–**:
   - åˆå§‹åŒ–åªéœ€ä¸€æ¬¡
   - ä½¿ç”¨ GPU å¯å¤§å¹…æå‡é€Ÿåº¦
   - æ‰¹æ¬¡è™•ç†æ™‚é‡è¤‡ä½¿ç”¨åŒä¸€å€‹ scorer å¯¦ä¾‹

---

## åŸ·è¡Œç¯„ä¾‹

```bash
cd /home/vipl/EchoLearn/worker
.venv/bin/python example_audio_scorer.py
```

---

## æŠ€è¡“ç´°ç¯€

### ä½¿ç”¨çš„æ¨¡å‹å’Œå·¥å…·
- **PhoneCTC**: facebook/wav2vec2-lv-60-espeak-cv-ftï¼ˆå¤šèªè¨€éŸ³ç´ è­˜åˆ¥ï¼‰
- **SpeechMetrics**: åŸºæ–¼ Praat/Parselmouth çš„éŸ»å¾‹åˆ†æ
- **Whisper**: OpenAI Whisper base modelï¼ˆèªéŸ³è­˜åˆ¥ï¼‰
- **DTW**: Dynamic Time Warping ç”¨æ–¼ç‰¹å¾µå°é½Š

### æ€§èƒ½ç‰¹æ€§

| æŒ‡æ¨™ | è¨ˆç®—é€Ÿåº¦ | GPU åŠ é€Ÿ |
|------|---------|----------|
| PER, PPG, GOP | ä¸­ç­‰ | âœ… æ˜¯ |
| GPE_offset, FFE, Energy, VDE | å¿« | âŒ å¦ |
| WER | æ…¢ | âœ… æ˜¯ |

---

## ç›¸é—œæª”æ¡ˆ

- **æ ¸å¿ƒç¨‹å¼ç¢¼**: `src/services/audio_scorer.py`
- **ä½¿ç”¨ç¯„ä¾‹**: `example_audio_scorer.py`
- **æ¸¬è©¦è…³æœ¬**: `test_audio_scorer.py`
